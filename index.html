<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGrocer - Cloud Shopping List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scrollbar-thin:hover::-webkit-scrollbar-thumb { background: #94a3b8; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-in { animation: fadeIn 0.2s ease-out forwards; }
        
        /* Prevent body scroll during drag */
        .dragging-active { overflow: hidden; overscroll-behavior: none; }
        
        .column-dragging {
            opacity: 0.5;
            transform: scale(0.98);
            border: 2px dashed #6366f1 !important;
        }

        /* Smooth horizontal scrolling for favorites */
        .favorites-scroll {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 8px;
        }

        .drop-indicator {
            width: 4px;
            background: #6366f1;
            border-radius: 2px;
            margin: 0 -2px;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = JSON.parse(__firebase_config);
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'smart-grocer-v1';

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Plus: <path d="M12 5v14M5 12h14" />,
                Trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                ShoppingBasket: <path d="m5 11 4-7M19 11l-4-7M2 11h20M3.5 11l1.6 7.4c.2.9 1 1.6 2 1.6h9.8c1 0 1.8-.7 2-1.6l1.7-7.4M9 11v.5c0 .8.7 1.5 1.5 1.5s1.5-.7 1.5-1.5V11M15 11v.5c0 .8.7 1.5 1.5 1.5s1.5-.7 1.5-1.5V11" />,
                CheckSquare: <path d="m9 11 3 3L22 4M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />,
                Square: <rect width="18" height="18" x="3" y="3" rx="2" />,
                Zap: <path d="M13 2 L3 14h9l-1 8 10-12h-9l1-8z" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                ArrowDownUp: <path d="m3 16 4 4 4-4M7 20V4M21 8l-4-4-4 4M17 4v16" />,
                Palette: <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />,
                User: <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
                GripVertical: <path d="M9 5h.01M9 12h.01M9 19h.01M15 5h.01M15 12h.01M15 19h.01" />
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const PRESET_COLORS = [
            { id: 'emerald', class: 'bg-emerald-50 text-emerald-700 border-emerald-100' },
            { id: 'amber', class: 'bg-amber-50 text-amber-700 border-amber-100' },
            { id: 'sky', class: 'bg-sky-50 text-sky-700 border-sky-100' },
            { id: 'indigo', class: 'bg-indigo-50 text-indigo-700 border-indigo-100' },
            { id: 'rose', class: 'bg-rose-50 text-rose-700 border-rose-100' },
            { id: 'orange', class: 'bg-orange-50 text-orange-700 border-orange-100' },
            { id: 'slate', class: 'bg-slate-100 text-slate-700 border-slate-200' },
            { id: 'violet', class: 'bg-violet-50 text-violet-700 border-violet-100' }
        ];

        const INITIAL_CATEGORIES = [
            { id: 'fruit-veg', name: 'Fruit & Veg', icon: 'ðŸŽ', color: 'bg-emerald-50 text-emerald-700 border-emerald-100' },
            { id: 'food-cupboard', name: 'Food Cupboard', icon: 'ðŸ¥«', color: 'bg-amber-50 text-amber-700 border-amber-100' },
            { id: 'chilled', name: 'Chilled', icon: 'ðŸ§Š', color: 'bg-sky-50 text-sky-700 border-sky-100' },
            { id: 'frozen', name: 'Frozen', icon: 'â„ï¸', color: 'bg-indigo-50 text-indigo-700 border-indigo-100' },
            { id: 'bakery', name: 'Bakery', icon: 'ðŸ¥', color: 'bg-orange-50 text-orange-700 border-orange-100' },
            { id: 'other', name: 'Other', icon: 'ðŸ“¦', color: 'bg-slate-100 text-slate-700 border-slate-200' }
        ];

        const App = () => {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [categories, setCategories] = useState(INITIAL_CATEGORIES);
            const [freq, setFreq] = useState({});
            const [showQuickAdd, setShowQuickAdd] = useState(true);
            const [draggedColIdx, setDraggedColIdx] = useState(null);
            const [draggedItemId, setDraggedItemId] = useState(null);
            const [editingCatId, setEditingCatId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authMode, setAuthMode] = useState('login');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [errorMsg, setErrorMsg] = useState('');

            const touchState = useRef({ type: null, startIdx: null, id: null, x: 0, y: 0, timer: null });
            const columnRefs = useRef({});
            const itemRefs = useRef({});

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth Error", e); }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (!u) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const userDocRef = db.doc(`artifacts/${appId}/users/${user.uid}/userData/main`);
                const unsubscribe = userDocRef.onSnapshot((snapshot) => {
                    if (snapshot.exists) {
                        const data = snapshot.data();
                        setItems(data.items || []);
                        setCategories(data.categories || INITIAL_CATEGORIES);
                        setFreq(data.freq || {});
                    } else {
                        userDocRef.set({ items: [], categories: INITIAL_CATEGORIES, freq: {} });
                    }
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore Error", err);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const updateFirestore = async (newData) => {
                if (!user) return;
                const userDocRef = db.doc(`artifacts/${appId}/users/${user.uid}/userData/main`);
                try {
                    await userDocRef.update(newData);
                } catch (e) {
                    console.error("Update failed", e);
                }
            };

            const handleAuth = async () => {
                if (!username.trim() || !password.trim()) {
                    setErrorMsg("Please fill in all fields.");
                    return;
                }
                setLoading(true);
                setErrorMsg('');
                try {
                    const credsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('credentials');
                    if (authMode === 'register') {
                        const existing = await credsRef.doc(username.toLowerCase()).get();
                        if (existing.exists) {
                            setErrorMsg("Username already taken.");
                            setLoading(false);
                            return;
                        }
                        await credsRef.doc(username.toLowerCase()).set({
                            username: username,
                            password: password,
                            uid: user.uid
                        });
                        setShowAuthModal(false);
                    } else {
                        const doc = await credsRef.doc(username.toLowerCase()).get();
                        if (doc.exists && doc.data().password === password) {
                            setShowAuthModal(false);
                        } else {
                            setErrorMsg("Invalid username or password.");
                        }
                    }
                } catch (e) {
                    setErrorMsg("Connection error. Try again.");
                }
                setLoading(false);
            };

            const frequentItems = useMemo(() => 
                Object.entries(freq).map(([text, d]) => ({ text, ...d })).sort((a,b) => b.count - a.count).slice(0, 30)
            , [freq]);

            const addItem = (text, catId) => {
                if (!text.trim() || !user) return;
                const clean = text.trim();
                const newItem = { id: Date.now(), text: clean, category: catId, completed: false };
                const newFreq = { ...freq };
                const key = clean.toLowerCase();
                newFreq[key] = { count: (newFreq[key]?.count || 0) + 1, lastCat: catId, label: clean };
                updateFirestore({ items: [newItem, ...items], freq: newFreq });
            };

            const toggleItem = (id) => {
                const newItems = items.map(i => i.id === id ? {...i, completed: !i.completed} : i);
                updateFirestore({ items: newItems });
            };

            const deleteItem = (id) => {
                const newItems = items.filter(i => i.id !== id);
                updateFirestore({ items: newItems });
            };
            
            const addColumn = () => {
                const newId = `cat-${Date.now()}`;
                const newCats = [...categories, { id: newId, name: 'New Section', icon: 'ðŸ›’', color: 'bg-slate-100 text-slate-700 border-slate-200' }];
                updateFirestore({ categories: newCats });
            };

            const deleteColumn = (id) => {
                if (categories.length <= 1) return;
                const newCats = categories.filter(c => c.id !== id);
                const newItems = items.filter(i => i.category !== id);
                updateFirestore({ categories: newCats, items: newItems });
            };

            const updateCategory = (id, updates) => {
                const newCats = categories.map(c => c.id === id ? { ...c, ...updates } : c);
                updateFirestore({ categories: newCats });
            };

            const reorderColumns = (sourceIdx, targetIdx) => {
                if (sourceIdx === targetIdx) return;
                const newCats = [...categories];
                const [moved] = newCats.splice(sourceIdx, 1);
                newCats.splice(targetIdx, 0, moved);
                updateFirestore({ categories: newCats });
            };

            const moveItem = (itemId, targetCatId, targetIdx = null) => {
                const itemToMove = items.find(i => i.id === itemId);
                if (!itemToMove) return;

                const otherItems = items.filter(i => i.id !== itemId);
                const catItems = otherItems.filter(i => i.category === targetCatId);
                const nonCatItems = otherItems.filter(i => i.category !== targetCatId);

                const updatedItem = { ...itemToMove, category: targetCatId };
                
                if (targetIdx !== null) {
                    catItems.splice(targetIdx, 0, updatedItem);
                } else {
                    catItems.push(updatedItem);
                }

                updateFirestore({ items: [...nonCatItems, ...catItems] });
            };

            // Desktop DnD Handlers
            const onDragStartCol = (e, index) => {
                setDraggedColIdx(index);
                e.dataTransfer.setData('colIndex', index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const onDragOverCol = (e, targetIdx) => {
                e.preventDefault();
                if (draggedColIdx === null) return;
                if (draggedColIdx !== targetIdx) {
                    reorderColumns(draggedColIdx, targetIdx);
                    setDraggedColIdx(targetIdx);
                }
            };

            const onDragEndCol = () => {
                setDraggedColIdx(null);
            };

            const onDragStartItem = (e, itemId) => {
                setDraggedItemId(itemId);
                e.dataTransfer.setData('itemId', itemId);
                e.stopPropagation();
            };

            const onDropOnColumn = (e, catId) => {
                e.preventDefault();
                const itemId = parseInt(e.dataTransfer.getData('itemId'));
                if (!isNaN(itemId)) {
                    moveItem(itemId, catId);
                    setDraggedItemId(null);
                }
            };

            const onDropOnItem = (e, targetId, catId) => {
                e.preventDefault();
                e.stopPropagation();
                const sourceId = parseInt(e.dataTransfer.getData('itemId'));
                if (!isNaN(sourceId) && sourceId !== targetId) {
                    const targetIdx = items.filter(i => i.category === catId).findIndex(i => i.id === targetId);
                    moveItem(sourceId, catId, targetIdx);
                    setDraggedItemId(null);
                }
            };

            // Mobile Touch Handlers
            const handleTouchStart = (e, type, id, index) => {
                const touch = e.touches[0];
                touchState.current = { 
                    type, 
                    id, 
                    startIdx: index, 
                    x: touch.clientX, 
                    y: touch.clientY,
                    timer: setTimeout(() => {
                        if (type === 'col') setDraggedColIdx(index);
                        if (type === 'item') setDraggedItemId(id);
                        document.body.classList.add('dragging-active');
                        window.navigator.vibrate?.(50);
                    }, 200) // Small delay to differentiate between scroll and drag
                };
            };

            const handleTouchMove = (e) => {
                if (!touchState.current.type) return;
                const touch = e.touches[0];
                
                // If moved too much before timer, cancel drag (user is probably scrolling)
                if (draggedColIdx === null && draggedItemId === null) {
                    const dx = Math.abs(touch.clientX - touchState.current.x);
                    const dy = Math.abs(touch.clientY - touchState.current.y);
                    if (dx > 10 || dy > 10) {
                        clearTimeout(touchState.current.timer);
                    }
                    return;
                }

                e.preventDefault(); // Stop scrolling once dragging
                
                if (draggedColIdx !== null) {
                    const x = touch.clientX;
                    let targetIdx = draggedColIdx;
                    categories.forEach((cat, idx) => {
                        const el = columnRefs.current[cat.id];
                        if (el) {
                            const rect = el.getBoundingClientRect();
                            if (x >= rect.left && x <= rect.right) targetIdx = idx;
                        }
                    });
                    if (targetIdx !== draggedColIdx) {
                        reorderColumns(draggedColIdx, targetIdx);
                        setDraggedColIdx(targetIdx);
                    }
                }
            };

            const handleTouchEnd = (e) => {
                clearTimeout(touchState.current.timer);
                if (!touchState.current.type) return;
                
                const touch = e.changedTouches[0];
                const x = touch.clientX;
                const y = touch.clientY;

                if (touchState.current.type === 'item' && draggedItemId !== null) {
                    let targetCatId = null;
                    let targetItemIdx = null;

                    categories.forEach(cat => {
                        const colEl = columnRefs.current[cat.id];
                        if (colEl) {
                            const colRect = colEl.getBoundingClientRect();
                            if (x >= colRect.left && x <= colRect.right) {
                                targetCatId = cat.id;
                                const catItems = items.filter(i => i.category === cat.id);
                                catItems.forEach((item, idx) => {
                                    const itemEl = itemRefs.current[item.id];
                                    if (itemEl) {
                                        const itemRect = itemEl.getBoundingClientRect();
                                        if (y >= itemRect.top && y <= itemRect.bottom) targetItemIdx = idx;
                                    }
                                });
                            }
                        }
                    });
                    if (targetCatId) moveItem(draggedItemId, targetCatId, targetItemIdx);
                }

                setDraggedColIdx(null);
                setDraggedItemId(null);
                touchState.current = { type: null };
                document.body.classList.remove('dragging-active');
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                            <p className="text-slate-400 font-bold text-xs uppercase tracking-widest">Loading List...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-40" onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                    {showAuthModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl animate-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold">{authMode === 'login' ? 'Welcome Back' : 'Create Account'}</h2>
                                    <button onClick={() => {setShowAuthModal(false); setErrorMsg('');}} className="text-slate-400 hover:text-slate-600"><Icon name="X" /></button>
                                </div>
                                {errorMsg && <div className="mb-4 p-3 bg-red-50 text-red-600 text-xs font-bold rounded-lg border border-red-100">{errorMsg}</div>}
                                <div className="space-y-4 mb-6">
                                    <input className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Username" value={username} onChange={(e) => setUsername(e.target.value)} />
                                    <input type="password" className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} />
                                </div>
                                <button onClick={handleAuth} className="w-full py-3 font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-lg shadow-indigo-200 transition-all mb-4">{authMode === 'login' ? 'Login' : 'Register'}</button>
                                <p className="text-center text-sm text-slate-500">{authMode === 'login' ? "New here?" : "Already have an account?"}<button onClick={() => setAuthMode(authMode === 'login' ? 'register' : 'login')} className="ml-2 text-indigo-600 font-bold hover:underline">{authMode === 'login' ? 'Create Account' : 'Sign In'}</button></p>
                            </div>
                        </div>
                    )}

                    <nav className="bg-white border-b px-6 py-4 sticky top-0 z-40 backdrop-blur-md bg-white/80">
                        <div className="max-w-[1800px] mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-indigo-600 rounded-lg text-white shadow-lg shadow-indigo-100"><Icon name="ShoppingBasket" /></div>
                                <div>
                                    <h1 className="font-bold text-lg leading-none">SmartGrocer</h1>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Cloud Sync</span>
                                        <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={() => setShowAuthModal(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-xl transition-all"><Icon name="User" size={16} className="text-slate-400" /><span className="text-xs font-bold text-slate-600">Sign In</span></button>
                                <button onClick={addColumn} className="hidden sm:flex text-sm font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl border border-indigo-100 hover:bg-indigo-100 transition-colors items-center gap-2"><Icon name="Plus" size={16} /> Add Column</button>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-[1800px] mx-auto p-6 flex flex-wrap gap-6 justify-start items-start">
                        {categories.map((cat, idx) => (
                            <div 
                                key={cat.id} 
                                ref={el => columnRefs.current[cat.id] = el}
                                draggable 
                                onDragStart={(e) => onDragStartCol(e, idx)}
                                onDragOver={(e) => onDragOverCol(e, idx)}
                                onDragEnd={onDragEndCol}
                                onDrop={(e) => onDropOnColumn(e, cat.id)}
                                className={`flex flex-col w-full sm:w-[320px] transition-all duration-200 group/col relative ${draggedColIdx === idx ? 'column-dragging' : 'opacity-100'}`}
                            >
                                <div 
                                    onPointerDown={(e) => e.pointerType === 'touch' && handleTouchStart(e, 'col', null, idx)}
                                    className={`p-4 rounded-t-2xl border-x border-t font-bold flex flex-col gap-3 cursor-grab active:cursor-grabbing touch-none select-none transition-colors ${cat.color}`}
                                >
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2 overflow-hidden flex-1">
                                            <input value={cat.icon} onChange={(e) => updateCategory(cat.id, { icon: e.target.value })} className="w-8 h-8 flex items-center justify-center bg-white/40 rounded-lg text-center outline-none" />
                                            <input value={cat.name} onChange={(e) => updateCategory(cat.id, { name: e.target.value })} className="bg-transparent border-none outline-none w-full px-1" />
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => setEditingCatId(editingCatId === cat.id ? null : cat.id)} className="p-1.5 hover:bg-black/5 rounded-lg transition-colors"><Icon name="Palette" size={14} /></button>
                                            <button onClick={() => deleteColumn(cat.id)} className="p-1.5 hover:bg-red-500/10 hover:text-red-600 rounded-lg transition-colors"><Icon name="X" size={14} /></button>
                                        </div>
                                    </div>
                                    {editingCatId === cat.id && (
                                        <div className="flex flex-wrap gap-1.5 p-2 bg-white/50 rounded-xl animate-in">
                                            {PRESET_COLORS.map(color => (
                                                <button key={color.id} onClick={() => { updateCategory(cat.id, { color: color.class }); setEditingCatId(null); }} className={`w-6 h-6 rounded-full border-2 ${color.class} ${cat.color === color.class ? 'border-black/20' : 'border-transparent'}`} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="bg-white border-x border-b rounded-b-2xl flex-1 shadow-sm overflow-hidden">
                                    <div className="p-2 border-b bg-slate-50/50">
                                        <div className="flex items-center gap-2 px-2 bg-white border border-slate-200 rounded-lg">
                                            <Icon name="Plus" size={14} className="text-slate-400" />
                                            <input placeholder="Add item..." className="w-full text-sm py-2 outline-none" onKeyDown={(e) => { if(e.key === 'Enter') { addItem(e.target.value, cat.id); e.target.value = ''; } }} />
                                        </div>
                                    </div>
                                    <div className="p-2 space-y-1 min-h-[100px] max-h-[500px] overflow-y-auto scrollbar-thin">
                                        {items.filter(i => i.category === cat.id).map((item, iIdx) => (
                                            <div 
                                                key={item.id} 
                                                ref={el => itemRefs.current[item.id] = el}
                                                draggable
                                                onDragStart={(e) => onDragStartItem(e, item.id)}
                                                onDragOver={(e) => e.preventDefault()}
                                                onDrop={(e) => onDropOnItem(e, item.id, cat.id)}
                                                className={`flex items-start gap-2 p-2.5 bg-white hover:bg-slate-50 rounded-xl group border border-transparent transition-all cursor-grab active:cursor-grabbing ${draggedItemId === item.id ? 'opacity-20' : 'opacity-100'}`}
                                            >
                                                <div 
                                                    onPointerDown={(e) => e.pointerType === 'touch' && handleTouchStart(e, 'item', item.id, iIdx)}
                                                    className="mt-1 text-slate-300 group-hover:text-slate-400 touch-none"
                                                >
                                                    <Icon name="GripVertical" size={14} />
                                                </div>
                                                <button onClick={() => toggleItem(item.id)} className={`mt-0.5 flex-shrink-0 ${item.completed ? 'text-indigo-600' : 'text-slate-300'}`}>
                                                    <Icon name={item.completed ? 'CheckSquare' : 'Square'} size={20} />
                                                </button>
                                                <span className={`text-sm flex-1 break-words leading-tight ${item.completed ? 'line-through text-slate-400' : 'text-slate-700 font-medium'}`}>{item.text}</span>
                                                <button onClick={() => deleteItem(item.id)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all">
                                                    <Icon name="Trash2" size={14} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        ))}
                        <button onClick={addColumn} className="w-full sm:w-[320px] h-32 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center text-slate-400 hover:border-indigo-300 hover:text-indigo-500 transition-all group">
                            <Icon name="Plus" size={24} className="group-hover:scale-110" />
                            <span className="text-[10px] font-bold uppercase tracking-widest mt-2">New Column</span>
                        </button>
                    </div>

                    <div className={`fixed bottom-0 left-0 w-full transition-transform duration-300 z-50 ${showQuickAdd ? 'translate-y-0' : 'translate-y-[calc(100%-44px)]'}`}>
                        <div className="max-w-6xl mx-auto px-6">
                            <button onClick={() => setShowQuickAdd(!showQuickAdd)} className="mx-auto block bg-slate-800 text-white px-8 py-2.5 rounded-t-2xl text-[10px] font-bold tracking-[0.2em] flex items-center gap-3 shadow-2xl">
                                <Icon name="Zap" size={12} fill="#fbbf24" className="text-amber-400 stroke-none" /> QUICK FAVORITES ({frequentItems.length}) <Icon name="ArrowDownUp" size={10} className={showQuickAdd ? 'rotate-180' : ''} />
                            </button>
                            <div className="bg-white/95 backdrop-blur-xl border-t border-slate-200 p-6 shadow-2xl rounded-t-3xl h-44">
                                <div className="favorites-scroll scrollbar-thin h-full items-start">
                                    {frequentItems.length > 0 ? (
                                        frequentItems.map(f => {
                                            const cat = categories.find(c => c.id === f.lastCat) || categories[0];
                                            return (
                                                <button key={f.text} onClick={() => addItem(f.label, f.lastCat)} className="flex-shrink-0 bg-white border border-slate-200 p-3 rounded-2xl hover:border-indigo-500 hover:shadow-md transition-all active:scale-95 text-center min-w-[130px] h-32 flex flex-col justify-between group">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="text-xl transform group-hover:scale-110 transition-transform">{cat?.icon || 'ðŸ“¦'}</span>
                                                        <span className="text-[10px] font-black bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded-md">{f.count}</span>
                                                    </div>
                                                    <div className="text-xs font-bold truncate text-slate-700 mb-1">{f.label}</div>
                                                    <div className="text-[9px] text-slate-400 uppercase tracking-tighter truncate">{cat?.name}</div>
                                                </button>
                                            );
                                        })
                                    ) : (
                                        <div className="flex flex-col items-center justify-center w-full h-full text-slate-400 italic text-sm">
                                            Start adding items to see favorites here!
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

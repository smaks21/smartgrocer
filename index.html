<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Grocery Keeper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
    <div id="app"></div>

    <script>
        // --- Firebase Config & Init ---
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'grocery-keeper-v2';

        // --- Load Libraries & Mount ---
        const loadScript = (url) => new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            document.head.appendChild(script);
        });

        async function init() {
            await loadScript('https://unpkg.com/react@18/umd/react.production.min.js');
            await loadScript('https://unpkg.com/react-dom@18/umd/react-dom.production.min.js');
            
            // Define Component inside init to ensure React is defined
            const { useState, useEffect, useMemo } = React;

            function App() {
                const [fbUser, setFbUser] = useState(null);
                const [user, setUser] = useState(null);
                const [authMode, setAuthMode] = useState('login');
                const [credsInput, setCredsInput] = useState({ username: '', password: '', displayName: '' });
                const [error, setError] = useState('');
                const [loading, setLoading] = useState(false);
                const [storedCredentials, setStoredCredentials] = useState([]);

                // List State
                const [items, setItems] = useState([]);
                const [categories, setCategories] = useState([
                    { id: 'fruit-veg', name: 'Fruit & Veg', icon: 'ðŸŽ', color: 'bg-emerald-50 text-emerald-700 border-emerald-100' },
                    { id: 'food-cupboard', name: 'Food Cupboard', icon: 'ðŸ¥«', color: 'bg-amber-50 text-amber-700 border-amber-100' },
                    { id: 'chilled', name: 'Chilled', icon: 'ðŸ§Š', color: 'bg-sky-50 text-sky-700 border-sky-100' }
                ]);
                const [frequencyData, setFrequencyData] = useState({});

                // Initialize Auth (Rule 3)
                useEffect(() => {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await auth.signInWithCustomToken(__initial_auth_token);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch (e) { console.error("Auth error", e); }
                    };
                    initAuth();

                    const unsubscribe = auth.onAuthStateChanged((firebaseUser) => {
                        setFbUser(firebaseUser);
                        if (firebaseUser) {
                            const saved = localStorage.getItem('grocery-keeper-session');
                            if (saved) setUser(JSON.parse(saved));
                        }
                    });
                    return () => unsubscribe();
                }, []);

                // Sync User "Credentials"
                useEffect(() => {
                    if (!fbUser) return;
                    const credsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('credentials');
                    return credsRef.onSnapshot(snap => {
                        setStoredCredentials(snap.docs.map(doc => doc.data()));
                    }, (err) => console.error("Firestore sync error:", err));
                }, [fbUser]);

                // Load/Save User Data
                useEffect(() => {
                    if (user) {
                        const data = localStorage.getItem(`data-${user.username}`);
                        if (data) {
                            const parsed = JSON.parse(data);
                            setItems(parsed.items || []);
                            setFrequencyData(parsed.freq || {});
                        }
                    }
                }, [user]);

                useEffect(() => {
                    if (user) {
                        localStorage.setItem(`data-${user.username}`, JSON.stringify({ items, freq: frequencyData }));
                    }
                }, [items, frequencyData, user]);

                const handleAuth = async (e) => {
                    e.preventDefault();
                    setLoading(true);
                    setError('');
                    const { username, password, displayName } = credsInput;
                    const normalizedUser = username.toLowerCase().trim();

                    try {
                        if (authMode === 'signup') {
                            if (!username || !password || !displayName) {
                                setError("All fields required");
                            } else if (storedCredentials.some(u => u.username === normalizedUser)) {
                                setError("Username taken");
                            } else {
                                const newUser = { username: normalizedUser, password, displayName };
                                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('credentials').add(newUser);
                                setUser(newUser);
                                localStorage.setItem('grocery-keeper-session', JSON.stringify(newUser));
                            }
                        } else {
                            const found = storedCredentials.find(u => u.username === normalizedUser && u.password === password);
                            if (found) {
                                setUser(found);
                                localStorage.setItem('grocery-keeper-session', JSON.stringify(found));
                            } else if (username === 'admin' && password === 'password123') {
                                const admin = { username: 'admin', displayName: 'Admin' };
                                setUser(admin);
                                localStorage.setItem('grocery-keeper-session', JSON.stringify(admin));
                            } else {
                                setError("Invalid credentials");
                            }
                        }
                    } catch (err) {
                        setError("Authentication failed. Try again.");
                    }
                    setLoading(false);
                };

                const addItem = (text, catId) => {
                    if (!text.trim()) return;
                    setItems([{ id: Date.now(), text, category: catId, completed: false }, ...items]);
                    setFrequencyData(prev => ({
                        ...prev,
                        [text.toLowerCase()]: { count: (prev[text.toLowerCase()]?.count || 0) + 1, lastCat: catId, raw: text }
                    }));
                };

                const logout = () => {
                    setUser(null);
                    localStorage.removeItem('grocery-keeper-session');
                };

                if (!user) {
                    return React.createElement('div', { className: 'min-h-screen flex items-center justify-center p-4' }, 
                        React.createElement('div', { className: 'bg-white p-8 rounded-[2rem] shadow-xl w-full max-w-md border' },
                            React.createElement('div', { className: 'text-center mb-8' },
                                React.createElement('div', { className: 'w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white mx-auto mb-4 text-2xl' }, 
                                    authMode === 'login' ? 'ðŸ”’' : 'ðŸ‘¤'
                                ),
                                React.createElement('h1', { className: 'text-2xl font-black text-slate-800' }, 'Grocery Keeper'),
                                React.createElement('p', { className: 'text-slate-400 font-bold text-[10px] uppercase tracking-widest mt-1' }, 
                                    authMode === 'login' ? 'Welcome Back' : 'Create User'
                                )
                            ),
                            React.createElement('form', { onSubmit: handleAuth, className: 'space-y-4' },
                                authMode === 'signup' && React.createElement('input', { 
                                    type: 'text', placeholder: 'Display Name', required: true,
                                    className: 'w-full bg-slate-100 rounded-xl px-5 py-4 font-bold outline-none focus:ring-2 focus:ring-indigo-200',
                                    value: credsInput.displayName, onChange: e => setCredsInput({...credsInput, displayName: e.target.value})
                                }),
                                React.createElement('input', { 
                                    type: 'text', placeholder: 'Username', required: true,
                                    className: 'w-full bg-slate-100 rounded-xl px-5 py-4 font-bold outline-none focus:ring-2 focus:ring-indigo-200',
                                    value: credsInput.username, onChange: e => setCredsInput({...credsInput, username: e.target.value})
                                }),
                                React.createElement('input', { 
                                    type: 'password', placeholder: 'Password', required: true,
                                    className: 'w-full bg-slate-100 rounded-xl px-5 py-4 font-bold outline-none focus:ring-2 focus:ring-indigo-200',
                                    value: credsInput.password, onChange: e => setCredsInput({...credsInput, password: e.target.value})
                                }),
                                error && React.createElement('p', { className: 'text-red-500 text-xs font-bold text-center' }, error),
                                React.createElement('button', { 
                                    disabled: loading, 
                                    className: 'w-full bg-indigo-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-indigo-700 active:scale-95 transition-all'
                                }, loading ? 'Processing...' : (authMode === 'login' ? 'Sign In' : 'Register'))
                            ),
                            React.createElement('button', { 
                                onClick: () => { setAuthMode(authMode === 'login' ? 'signup' : 'login'); setError(''); },
                                className: 'w-full mt-6 text-indigo-600 text-[10px] font-black uppercase tracking-widest hover:underline'
                            }, authMode === 'login' ? "Need an account? Sign Up" : "Back to Login")
                        )
                    );
                }

                return React.createElement('div', { className: 'pb-32' },
                    React.createElement('header', { className: 'sticky top-0 bg-white/80 backdrop-blur-md border-b p-4 z-20' },
                        React.createElement('div', { className: 'max-w-2xl mx-auto flex justify-between items-center' },
                            React.createElement('div', { className: 'flex items-center gap-3' },
                                React.createElement('div', { className: 'w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-xl' }, 'ðŸ›’'),
                                React.createElement('div', null,
                                    React.createElement('h2', { className: 'font-black text-slate-800' }, 'Groceries'),
                                    React.createElement('span', { className: 'text-[10px] font-black text-indigo-500 uppercase tracking-widest' }, user.displayName)
                                )
                            ),
                            React.createElement('button', { onClick: logout, className: 'text-slate-400 hover:text-red-500 font-bold text-xs' }, 'LOGOUT')
                        )
                    ),
                    React.createElement('main', { className: 'max-w-2xl mx-auto p-4 space-y-6 mt-4' },
                        categories.map(cat => 
                            React.createElement('section', { key: cat.id, className: 'bg-white rounded-[2rem] shadow-sm border overflow-hidden animate-in' },
                                React.createElement('div', { className: `p-5 flex justify-between items-center border-b ${cat.color}` },
                                    React.createElement('div', { className: 'flex items-center gap-3' },
                                        React.createElement('span', { className: 'text-xl' }, cat.icon),
                                        React.createElement('h3', { className: 'font-black text-sm uppercase tracking-tight' }, cat.name)
                                    )
                                ),
                                React.createElement('div', { className: 'p-4 space-y-2' },
                                    React.createElement('div', { className: 'relative' },
                                        React.createElement('input', { 
                                            className: 'w-full bg-slate-50 rounded-xl p-4 pr-12 font-bold outline-none focus:ring-2 focus:ring-slate-100',
                                            placeholder: 'Add to list...',
                                            onKeyDown: e => {
                                                if (e.key === 'Enter' && e.target.value) {
                                                    addItem(e.target.value, cat.id);
                                                    e.target.value = '';
                                                }
                                            }
                                        }),
                                        React.createElement('div', { className: 'absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 font-black text-xl' }, '+')
                                    ),
                                    React.createElement('div', { className: 'pt-2' },
                                        items.filter(i => i.category === cat.id).map(item => 
                                            React.createElement('div', { key: item.id, className: 'flex items-center gap-3 p-3 group' },
                                                React.createElement('button', { 
                                                    onClick: () => setItems(items.map(i => i.id === item.id ? {...i, completed: !i.completed} : i)),
                                                    className: `w-6 h-6 rounded-md border-2 flex items-center justify-center transition-colors ${item.completed ? 'bg-indigo-600 border-indigo-600 text-white' : 'border-slate-200'}`
                                                }, item.completed ? 'âœ“' : ''),
                                                React.createElement('span', { className: `flex-1 font-bold ${item.completed ? 'text-slate-300 line-through' : 'text-slate-700'}` }, item.text),
                                                React.createElement('button', { 
                                                    onClick: () => setItems(items.filter(i => i.id !== item.id)),
                                                    className: 'opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 font-bold text-xl'
                                                }, 'Ã—')
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    React.createElement('div', { className: 'fixed bottom-0 left-0 w-full p-4 pointer-events-none' },
                        React.createElement('div', { className: 'max-w-2xl mx-auto pointer-events-auto' },
                            React.createElement('div', { className: 'bg-slate-900 text-white rounded-[2rem] p-4 shadow-2xl overflow-x-auto flex gap-3 scrollbar-hide' },
                                React.createElement('div', { className: 'flex-shrink-0 flex items-center px-4 border-r border-slate-700 text-amber-400 font-black' }, 'âš¡'),
                                Object.values(frequencyData).sort((a,b) => b.count - a.count).slice(0, 8).map(f => 
                                    React.createElement('button', { 
                                        key: f.raw,
                                        onClick: () => addItem(f.raw, f.lastCat),
                                        className: 'flex-shrink-0 bg-slate-800 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-indigo-600 transition-colors'
                                    }, f.raw)
                                )
                            )
                        )
                    )
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('app'));
            root.render(React.createElement(App));
        }

        window.onload = init;
    </script>
</body>
</html>

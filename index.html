<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartGrocer - Cloud Shopping List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK Compat (Standard Scripts to avoid module/babel conflicts) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-in { animation: fadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase Initialization ---
        const firebaseConfig = JSON.parse(__firebase_config);
        
        // Ensure we only initialize once
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'smart-grocer-v1';

        // Inline SVG Icons
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Plus: <path d="M12 5v14M5 12h14" />,
                Trash2: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />,
                ShoppingBasket: <path d="m5 11 4-7M19 11l-4-7M2 11h20M3.5 11l1.6 7.4c.2.9 1 1.6 2 1.6h9.8c1 0 1.8-.7 2-1.6l1.7-7.4M9 11v.5c0 .8.7 1.5 1.5 1.5s1.5-.7 1.5-1.5V11M15 11v.5c0 .8.7 1.5 1.5 1.5s1.5-.7 1.5-1.5V11" />,
                CheckSquare: <path d="m9 11 3 3L22 4M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />,
                Square: <rect width="18" height="18" x="3" y="3" rx="2" />,
                Zap: <path d="M13 2 L3 14h9l-1 8 10-12h-9l1-8z" />,
                X: <path d="M18 6 6 18M6 6l12 12" />,
                ArrowDownUp: <path d="m3 16 4 4 4-4M7 20V4M21 8l-4-4-4 4M17 4v16" />,
                History: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8M3 3v5h5M12 7v5l4 2" />,
                LayoutGrid: <path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" />,
                Palette: <path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />,
                User: <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />,
                LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const PRESET_COLORS = [
            { id: 'emerald', class: 'bg-emerald-50 text-emerald-700 border-emerald-100' },
            { id: 'amber', class: 'bg-amber-50 text-amber-700 border-amber-100' },
            { id: 'sky', class: 'bg-sky-50 text-sky-700 border-sky-100' },
            { id: 'indigo', class: 'bg-indigo-50 text-indigo-700 border-indigo-100' },
            { id: 'rose', class: 'bg-rose-50 text-rose-700 border-rose-100' },
            { id: 'orange', class: 'bg-orange-50 text-orange-700 border-orange-100' },
            { id: 'slate', class: 'bg-slate-100 text-slate-700 border-slate-200' },
            { id: 'violet', class: 'bg-violet-50 text-violet-700 border-violet-100' }
        ];

        const INITIAL_CATEGORIES = [
            { id: 'fruit-veg', name: 'Fruit & Veg', icon: 'ðŸŽ', color: 'bg-emerald-50 text-emerald-700 border-emerald-100' },
            { id: 'food-cupboard', name: 'Food Cupboard', icon: 'ðŸ¥«', color: 'bg-amber-50 text-amber-700 border-amber-100' },
            { id: 'chilled', name: 'Chilled', icon: 'ðŸ§Š', color: 'bg-sky-50 text-sky-700 border-sky-100' },
            { id: 'frozen', name: 'Frozen', icon: 'â„ï¸', color: 'bg-indigo-50 text-indigo-700 border-indigo-100' },
            { id: 'bakery', name: 'Bakery', icon: 'ðŸ¥', color: 'bg-orange-50 text-orange-700 border-orange-100' },
            { id: 'other', name: 'Other', icon: 'ðŸ“¦', color: 'bg-slate-100 text-slate-700 border-slate-200' }
        ];

        const App = () => {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [categories, setCategories] = useState(INITIAL_CATEGORIES);
            const [freq, setFreq] = useState({});
            const [showQuickAdd, setShowQuickAdd] = useState(true);
            const [draggedColIdx, setDraggedColIdx] = useState(null);
            const [editingCatId, setEditingCatId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showUserModal, setShowUserModal] = useState(false);
            const [newUserIdInput, setNewUserIdInput] = useState('');

            // Auth Effect
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth Error", e); }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (!u) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Firestore Data Sync Effect
            useEffect(() => {
                if (!user) return;
                
                // Path strictly follows mandatory RULE 1
                const userDocRef = db.doc(`artifacts/${appId}/users/${user.uid}/userData/main`);
                
                const unsubscribe = userDocRef.onSnapshot((snapshot) => {
                    if (snapshot.exists) {
                        const data = snapshot.data();
                        setItems(data.items || []);
                        setCategories(data.categories || INITIAL_CATEGORIES);
                        setFreq(data.freq || {});
                    } else {
                        userDocRef.set({ items: [], categories: INITIAL_CATEGORIES, freq: {} });
                    }
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore Error", err);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const handleSwitchUser = async () => {
                if (!newUserIdInput.trim()) return;
                setLoading(true);
                setShowUserModal(false);
                
                try {
                    // In a production app, we would use real credentials. 
                    // For this environment, we sign in anonymously to get a fresh UID if needed,
                    // but since the query asks to "switch user" conceptually, 
                    // we'll simulate the state shift by signing out/in.
                    await auth.signOut();
                    // We'll let the user sign in anonymously again, 
                    // but in a custom implementation you'd map newUserIdInput to a token.
                    // For this preview, we'll simply refresh the anonymous session.
                    await auth.signInAnonymously();
                } catch (e) {
                    console.error("Switch User Error", e);
                }
                setNewUserIdInput('');
            };

            const updateFirestore = async (newData) => {
                if (!user) return;
                const userDocRef = db.doc(`artifacts/${appId}/users/${user.uid}/userData/main`);
                try {
                    await userDocRef.update(newData);
                } catch (e) {
                    console.error("Update failed", e);
                }
            };

            const frequentItems = useMemo(() => 
                Object.entries(freq).map(([text, d]) => ({ text, ...d })).sort((a,b) => b.count - a.count).slice(0, 10)
            , [freq]);

            const addItem = (text, catId) => {
                if (!text.trim() || !user) return;
                const clean = text.trim();
                const newItem = { id: Date.now(), text: clean, category: catId, completed: false };
                
                const newFreq = { ...freq };
                const key = clean.toLowerCase();
                newFreq[key] = { count: (newFreq[key]?.count || 0) + 1, lastCat: catId, label: clean };

                updateFirestore({
                    items: [newItem, ...items],
                    freq: newFreq
                });
            };

            const toggleItem = (id) => {
                const newItems = items.map(i => i.id === id ? {...i, completed: !i.completed} : i);
                updateFirestore({ items: newItems });
            };

            const deleteItem = (id) => {
                const newItems = items.filter(i => i.id !== id);
                updateFirestore({ items: newItems });
            };
            
            const addColumn = () => {
                const newId = `cat-${Date.now()}`;
                const newCats = [...categories, { id: newId, name: 'New Section', icon: 'ðŸ›’', color: 'bg-slate-100 text-slate-700 border-slate-200' }];
                updateFirestore({ categories: newCats });
            };

            const deleteColumn = (id) => {
                if (categories.length <= 1) return;
                const newCats = categories.filter(c => c.id !== id);
                const newItems = items.filter(i => i.category !== id);
                updateFirestore({ categories: newCats, items: newItems });
            };

            const updateCategory = (id, updates) => {
                const newCats = categories.map(c => c.id === id ? { ...c, ...updates } : c);
                updateFirestore({ categories: newCats });
            };

            const onDragStartCol = (e, index) => {
                setDraggedColIdx(index);
                e.dataTransfer.setData('colIndex', index);
            };

            const onDropCol = (e, targetIdx) => {
                e.preventDefault();
                const sourceIdx = parseInt(e.dataTransfer.getData('colIndex'));
                if (isNaN(sourceIdx) || sourceIdx === targetIdx) return;

                const newCats = [...categories];
                const [moved] = newCats.splice(sourceIdx, 1);
                newCats.splice(targetIdx, 0, moved);
                updateFirestore({ categories: newCats });
                setDraggedColIdx(null);
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50">
                        <div className="flex flex-col items-center gap-4">
                            <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                            <p className="text-slate-400 font-bold text-xs uppercase tracking-widest">Accessing Secure Vault...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-40">
                    {/* User Switch Modal */}
                    {showUserModal && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
                            <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl animate-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold">Switch Account</h2>
                                    <button onClick={() => setShowUserModal(false)} className="text-slate-400 hover:text-slate-600">
                                        <Icon name="X" />
                                    </button>
                                </div>
                                <p className="text-sm text-slate-500 mb-6">Enter a new Identifier to access a different shared list or personal space.</p>
                                <input 
                                    autoFocus
                                    className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500 mb-6 font-mono text-sm"
                                    placeholder="Enter User ID or Key..."
                                    value={newUserIdInput}
                                    onChange={(e) => setNewUserIdInput(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSwitchUser()}
                                />
                                <div className="flex gap-3">
                                    <button 
                                        onClick={() => setShowUserModal(false)}
                                        className="flex-1 py-3 font-bold text-slate-500 hover:bg-slate-100 rounded-xl transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={handleSwitchUser}
                                        className="flex-1 py-3 font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-lg shadow-indigo-200 transition-all"
                                    >
                                        Switch Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="bg-white border-b px-6 py-4 sticky top-0 z-40 backdrop-blur-md bg-white/80">
                        <div className="max-w-[1800px] mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-indigo-600 rounded-lg text-white shadow-lg shadow-indigo-100">
                                    <Icon name="ShoppingBasket" />
                                </div>
                                <div>
                                    <h1 className="font-bold text-lg leading-none">SmartGrocer</h1>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Cloud Sync</span>
                                        <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                <div 
                                    className="hidden md:flex flex-col items-end border-r pr-4 border-slate-100 cursor-pointer hover:opacity-70 transition-opacity"
                                    onClick={() => setShowUserModal(true)}
                                >
                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Current User (Click to Switch)</span>
                                    <span className="text-xs font-mono text-slate-600 flex items-center gap-2">
                                        {user?.uid} <Icon name="LogOut" size={12} />
                                    </span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={addColumn} className="text-sm font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl border border-indigo-100 hover:bg-indigo-100 transition-colors flex items-center gap-2">
                                        <Icon name="Plus" size={16} /> Add Column
                                    </button>
                                    <button onClick={() => updateFirestore({ items: items.filter(i => !i.completed) })} className="text-sm font-bold text-slate-500 hover:text-red-600 px-4 py-2 rounded-xl hover:bg-red-50 transition-colors flex items-center gap-2">
                                        <Icon name="Trash2" size={16} /> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-[1800px] mx-auto p-6 flex flex-wrap gap-6 justify-start items-start">
                        {categories.map((cat, idx) => (
                            <div 
                                key={cat.id} 
                                draggable 
                                onDragStart={(e) => onDragStartCol(e, idx)}
                                onDragOver={(e) => e.preventDefault()}
                                onDrop={(e) => onDropCol(e, idx)}
                                className={`flex flex-col w-full sm:w-[320px] transition-all group/col ${draggedColIdx === idx ? 'opacity-40 grayscale scale-95' : 'opacity-100'}`}
                            >
                                <div className={`p-4 rounded-t-2xl border-x border-t font-bold flex flex-col gap-3 cursor-grab active:cursor-grabbing ${cat.color}`}>
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2 overflow-hidden flex-1">
                                            <input 
                                                value={cat.icon}
                                                onChange={(e) => updateCategory(cat.id, { icon: e.target.value })}
                                                className="w-8 h-8 flex items-center justify-center bg-white/40 rounded-lg text-center outline-none focus:ring-2 focus:ring-black/10"
                                            />
                                            <input 
                                                value={cat.name}
                                                onChange={(e) => updateCategory(cat.id, { name: e.target.value })}
                                                className="bg-transparent border-none outline-none w-full focus:ring-1 focus:ring-black/5 rounded px-1"
                                            />
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button 
                                                onClick={() => setEditingCatId(editingCatId === cat.id ? null : cat.id)}
                                                className="p-1.5 hover:bg-black/5 rounded-lg transition-colors"
                                            >
                                                <Icon name="Palette" size={14} />
                                            </button>
                                            <button onClick={() => deleteColumn(cat.id)} className="p-1.5 hover:bg-red-500/10 hover:text-red-600 rounded-lg transition-colors">
                                                <Icon name="X" size={14} />
                                            </button>
                                        </div>
                                    </div>

                                    {editingCatId === cat.id && (
                                        <div className="flex flex-wrap gap-1.5 p-2 bg-white/50 rounded-xl animate-in">
                                            {PRESET_COLORS.map(color => (
                                                <button 
                                                    key={color.id}
                                                    onClick={() => {
                                                        updateCategory(cat.id, { color: color.class });
                                                        setEditingCatId(null);
                                                    }}
                                                    className={`w-6 h-6 rounded-full border-2 ${color.class} ${cat.color === color.class ? 'border-black/20 scale-110 shadow-sm' : 'border-transparent hover:scale-105'}`}
                                                />
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="bg-white border-x border-b rounded-b-2xl flex-1 shadow-sm overflow-hidden">
                                    <div className="p-2 border-b bg-slate-50/50">
                                        <div className="flex items-center gap-2 px-2 bg-white border border-slate-200 rounded-lg focus-within:ring-2 focus-within:ring-indigo-100 transition-all">
                                            <Icon name="Plus" size={14} className="text-slate-400" />
                                            <input 
                                                placeholder="Add item..." 
                                                className="w-full text-sm py-2 outline-none"
                                                onKeyDown={(e) => { 
                                                    if(e.key === 'Enter') { 
                                                        e.preventDefault();
                                                        addItem(e.target.value, cat.id); 
                                                        e.target.value = ''; 
                                                        e.target.blur();
                                                    }
                                                }}
                                            />
                                        </div>
                                    </div>
                                    <div className="p-2 space-y-1 min-h-[100px] max-h-[500px] overflow-y-auto scrollbar-thin">
                                        {items.filter(i => i.category === cat.id).length === 0 ? (
                                            <div className="py-10 flex flex-col items-center justify-center text-slate-300 opacity-50 italic">
                                                <Icon name="LayoutGrid" size={20} strokeWidth={1.5} />
                                                <span className="text-[10px] uppercase font-bold tracking-widest mt-2">Empty</span>
                                            </div>
                                        ) : (
                                            items.filter(i => i.category === cat.id).map(item => (
                                                <div key={item.id} className="flex items-start gap-2 p-2.5 hover:bg-slate-50 rounded-xl group transition-colors border border-transparent hover:border-slate-100">
                                                    <button onClick={() => toggleItem(item.id)} className={`mt-0.5 flex-shrink-0 transition-colors ${item.completed ? 'text-indigo-600' : 'text-slate-300 hover:text-indigo-200'}`}>
                                                        <Icon name={item.completed ? 'CheckSquare' : 'Square'} size={20} />
                                                    </button>
                                                    <span className={`text-sm flex-1 break-words leading-tight ${item.completed ? 'line-through text-slate-400' : 'text-slate-700 font-medium'}`}>{item.text}</span>
                                                    <button onClick={() => deleteItem(item.id)} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all"><Icon name="Trash2" size={14} /></button>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                        
                        <button onClick={addColumn} className="w-full sm:w-[320px] h-32 border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center text-slate-400 hover:border-indigo-300 hover:text-indigo-500 transition-all group">
                            <Icon name="Plus" size={24} className="group-hover:scale-110 transition-transform" />
                            <span className="text-[10px] font-bold uppercase tracking-widest mt-2">New Column</span>
                        </button>
                    </div>

                    <div className={`fixed bottom-0 left-0 w-full transition-transform duration-300 z-50 ${showQuickAdd ? 'translate-y-0' : 'translate-y-[calc(100%-44px)]'}`}>
                        <div className="max-w-4xl mx-auto px-6">
                            <button onClick={() => setShowQuickAdd(!showQuickAdd)} className="mx-auto block bg-slate-800 text-white px-8 py-2.5 rounded-t-2xl text-[10px] font-bold tracking-[0.2em] flex items-center gap-3 shadow-2xl hover:bg-slate-700 transition-colors">
                                <Icon name="Zap" size={12} fill="#fbbf24" className="text-amber-400 stroke-none" /> QUICK FAVORITES <Icon name="ArrowDownUp" size={10} className={showQuickAdd ? 'rotate-180' : ''} />
                            </button>
                            <div className="bg-white/95 backdrop-blur-xl border-t border-slate-200 p-6 h-36 flex gap-4 overflow-x-auto scrollbar-thin shadow-2xl rounded-t-3xl">
                                {frequentItems.length === 0 ? (
                                    <div className="flex items-center justify-center w-full text-slate-400 text-xs italic gap-3">
                                        <Icon name="History" size={16} /> Start adding items to track your favorites
                                    </div>
                                ) : (
                                    frequentItems.map(f => {
                                        const cat = categories.find(c => c.id === f.lastCat) || categories[0];
                                        return (
                                            <button 
                                                key={f.text} 
                                                onClick={() => addItem(f.label, f.lastCat)}
                                                className="flex-shrink-0 bg-white border border-slate-200 p-3 rounded-2xl hover:border-indigo-500 hover:shadow-md transition-all active:scale-95 text-center min-w-[120px] flex flex-col justify-between"
                                            >
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="text-lg">{cat?.icon || 'ðŸ“¦'}</span>
                                                    <span className="text-[10px] font-black bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded-md">{f.count}</span>
                                                </div>
                                                <div className="text-xs font-bold truncate text-slate-700">{f.label}</div>
                                            </button>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
